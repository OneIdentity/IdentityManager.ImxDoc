<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>IMX Web - QER Library</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
        <link rel="stylesheet" href="../styles/material.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top d-block d-sm-none">
            <a href="../" class="navbar-brand">IMX Web - QER Library</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">













<ol class="breadcrumb">
  <li class="breadcrumb-item">Interfaces</li>
  <li class="breadcrumb-item"
  >
  EntitlementCountUpdateData</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a href="#info" 
                class="nav-link"
                class="nav-link active"
                role="tab" id="info-tab" data-bs-toggle="tab" data-link="info">Info</a>
        </li>
        <li class="nav-item">
            <a href="#source" 
                class="nav-link"
                
                role="tab" id="source-tab" data-bs-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/lib/itshop-config/request-shelf-entitlements/request-shelf-entitlements.component.ts</code>
        </p>




        <section data-compodoc="block-index">
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                        <a href="#count" 
>
                                            count
                                        </a>
                                </li>
                                <li>
                                        <a href="#recentDeleteAction" 
>
                                            recentDeleteAction
                                        </a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section data-compodoc="block-properties">
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="count"></a>
                                        <span class="name "><b>count</b>
                                            <a href="#count">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>count:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="recentDeleteAction"></a>
                                        <span class="name "><b>recentDeleteAction</b>
                                            <a href="#recentDeleteAction">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>recentDeleteAction:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Component, EventEmitter, Input, OnInit, Output, ViewChild } from &#x27;@angular/core&#x27;;
import { EuiSidesheetService } from &#x27;@elemental-ui/core&#x27;;
import { TranslateService } from &#x27;@ngx-translate/core&#x27;;

import { PortalRolesEntitlements } from &#x27;imx-api-qer&#x27;;
import { CollectionLoadParameters, DbObjectKey, DisplayColumns, EntitySchema, IClientProperty } from &#x27;imx-qbm-dbts&#x27;;
import {
  DataSourceToolbarSettings,
  DataSourceToolbarFilter,
  ClassloggerService,
  DataTableComponent,
  StorageService,
  HELPER_ALERT_KEY_PREFIX,
  SettingsService,
  MetadataService,
  DynamicMethodService,
  BusyService,
  HELP_CONTEXTUAL,
} from &#x27;qbm&#x27;;
import { QerApiService } from &#x27;../../qer-api-client.service&#x27;;
import { RequestsEntitySelectorComponent } from &#x27;../requests-selector/requests-entity-selector.component&#x27;;
import { ACTION_DISMISS, RequestsService } from &#x27;../requests.service&#x27;;

export interface EntitlementCountUpdateData {
  count: number;
  recentDeleteAction: boolean;
}

@Component({
  selector: &#x27;imx-request-shelf-entitlements&#x27;,
  templateUrl: &#x27;./request-shelf-entitlements.component.html&#x27;,
  styleUrls: [&#x27;../request-config-sidesheet-common.scss&#x27;],
})
export class RequestShelfEntitlementsComponent implements OnInit {
  @Input() public shelfId: string;
  @Input() public shopDisplay: string;
  @Output() public entitlementCountUpdated &#x3D; new EventEmitter&lt;EntitlementCountUpdateData&gt;();
  @ViewChild(&#x27;dataTable&#x27;, { static: false }) public dataTable: DataTableComponent&lt;PortalRolesEntitlements&gt;;

  public dstSettings: DataSourceToolbarSettings;
  public navigationState: CollectionLoadParameters;
  public filterOptions: DataSourceToolbarFilter[] &#x3D; [];
  public selectedEntitlements: PortalRolesEntitlements[] &#x3D; [];
  public productContextIds &#x3D; HELP_CONTEXTUAL.ConfigurationRequestsShelvesProduct;

  private displayedColumns: IClientProperty[];

  public DisplayColumns &#x3D; DisplayColumns;

  public entitySchema: EntitySchema;

  public entitlementTypes: Map&lt;string, string&gt; &#x3D; new Map();

  public busyService &#x3D; new BusyService();

  constructor(
    private readonly logger: ClassloggerService,
    public readonly requestsService: RequestsService,
    private readonly qerApiService: QerApiService,
    private readonly settingsService: SettingsService,
    private readonly metadata: MetadataService,
    private readonly sidesheet: EuiSidesheetService,
    private readonly translate: TranslateService,
    private readonly dynamicMethodService: DynamicMethodService
  ) {
    this.navigationState &#x3D; { PageSize: this.settingsService.DefaultPageSize, StartIndex: 0 };
    this.entitySchema &#x3D; qerApiService.typedClient.PortalRolesEntitlements.GetSchema();
    this.displayedColumns &#x3D; [
      this.entitySchema.Columns[DisplayColumns.DISPLAY_PROPERTYNAME],
      this.entitySchema.Columns.XOrigin,
      this.entitySchema.Columns.XDateInserted,
    ];
  }

  get isMobile(): boolean {
    return document.body.offsetWidth &lt;&#x3D; 768;
  }

  public async ngOnInit(): Promise&lt;void&gt; {
    await this.navigate();
  }

  public async onSearch(keywords: string): Promise&lt;void&gt; {
    this.logger.debug(this, &#x60;Searching for: ${keywords}&#x60;);
    this.navigationState.StartIndex &#x3D; 0;
    this.navigationState.search &#x3D; keywords;
    await this.navigate();
  }

  public onEntitlementSelected(selected: PortalRolesEntitlements[]): void {
    this.logger.debug(this, &#x60;Selected entitlements changed&#x60;);
    this.logger.trace(&#x60;New entitlement selections&#x60;, selected);
    this.selectedEntitlements &#x3D; selected;
  }

  /**
   * Occurs when the navigation state has changed - e.g. users clicks on the next page button.
   *
   */
  public async onNavigationStateChanged(newState?: CollectionLoadParameters): Promise&lt;void&gt; {
    if (newState) {
      this.navigationState &#x3D; newState;
    }
    await this.navigate();
  }

  public async openEntitlementSelector(): Promise&lt;void&gt; {
    const sidesheetRef &#x3D; this.sidesheet.open(RequestsEntitySelectorComponent, {
      title: await this.translate.get(&#x27;#LDS#Heading Add Products&#x27;).toPromise(),
      subTitle: this.shopDisplay,
      padding: &#x27;0px&#x27;,
      width: &#x27;max(55%,550px)&#x27;,
      testId: &#x27;request-shelf-entitlements-add-products&#x27;,
      data: {
        shelfId: this.shelfId,
      },
    });
    sidesheetRef.afterClosed().subscribe((selectedValues: string[]) &#x3D;&gt; {
      if (selectedValues) {
        this.processEntitlementSelections(selectedValues);
      }
    });
  }

  public async removeEntitlements(): Promise&lt;void&gt; {
    const isBusy &#x3D; this.busyService.beginBusy();
    try {
      const promises &#x3D; [];
      // TODO what if only some succeed?
      this.selectedEntitlements.forEach((ent) &#x3D;&gt; {
        const entitlementKey &#x3D; DbObjectKey.FromXml(ent.ObjectKeyElement.value);
        promises.push(
          this.dynamicMethodService.delete(
            this.qerApiService.apiClient,
            &#x27;/portal/shop/config/entitlements/&#x27; + this.shelfId + &#x27;/&#x27; + entitlementKey.TableName + &#x27;/&#x27; + entitlementKey.Keys[0],
            {}
          )
        );
      });
      await Promise.all(promises);

      await this.navigate(true);
      // Reset table selections (removing references to now deleted members)
      this.dataTable.clearSelection();
      this.requestsService.openSnackbar(&#x27;#LDS#The products have been successfully removed.&#x27;, ACTION_DISMISS);
    } finally {
      isBusy.endBusy();
    }
  }

  private async processEntitlementSelections(values: string[]): Promise&lt;void&gt; {
    const isBusy &#x3D; this.busyService.beginBusy();
    try {
      await this.requestsService.selectedEntitlementType.addEntitlementSelections(this.shelfId, values);
      this.requestsService.openSnackbar(&#x27;#LDS#The products have been successfully added.&#x27;, ACTION_DISMISS);
      await this.navigate();
    } finally {
      isBusy.endBusy();
    }
  }

  private async navigate(recentDeleteAction: boolean &#x3D; false): Promise&lt;void&gt; {
    const isBusy &#x3D; this.busyService.beginBusy();
    const getParams: any &#x3D; this.navigationState;

    try {
      const data &#x3D; await this.qerApiService.typedClient.PortalRolesEntitlements.Get(&#x27;ITShopOrg&#x27;, this.shelfId, getParams);
      // Notify caller of new count, but only when a search is not applied, and indicate if an
      // entitlement was recently deleted
      if (!this.navigationState?.search || this.navigationState?.search &#x3D;&#x3D;&#x3D; &#x27;&#x27;) {
        const countUpdateData: EntitlementCountUpdateData &#x3D; {
          count: data.totalCount,
          recentDeleteAction,
        };
        this.entitlementCountUpdated.emit(countUpdateData);
      }
      this.dstSettings &#x3D; {
        displayedColumns: this.displayedColumns,
        dataSource: data,
        entitySchema: this.entitySchema,
        navigationState: this.navigationState,
        filters: this.filterOptions,
      };
      this.logger.debug(this, &#x60;Head at ${data.Data.length + this.navigationState.StartIndex} of ${data.totalCount} item(s)&#x60;);

      data.Data.forEach(async (item: PortalRolesEntitlements) &#x3D;&gt; {
        const objKey &#x3D; DbObjectKey.FromXml(item.ObjectKeyElement.value);
        var uid &#x3D; item.GetEntity().GetKeys().toString();
        var display: string;
        if (!this.entitlementTypes.has(objKey.TableName)) {
          const metadata &#x3D; await this.metadata.GetTableMetadata(objKey.TableName);
          this.entitlementTypes.set(uid, metadata.DisplaySingular);
          display &#x3D; metadata.DisplaySingular;
        } else {
          display &#x3D; this.entitlementTypes.get(objKey.TableName);
        }

        this.entitlementTypes.set(uid, display);
      });
    } finally {
      isBusy.endBusy();
    }
  }
}
</code></pre>
    </div>
</div>








                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'EntitlementCountUpdateData.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
