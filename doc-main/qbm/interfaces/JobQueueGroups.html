<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>IMX Web - QBM Library</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
        <link rel="stylesheet" href="../styles/material.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top d-block d-sm-none">
            <a href="../" class="navbar-brand">IMX Web - QBM Library</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">













<ol class="breadcrumb">
  <li class="breadcrumb-item">Interfaces</li>
  <li class="breadcrumb-item"
  >
  JobQueueGroups</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a href="#info" 
                class="nav-link"
                class="nav-link active"
                role="tab" id="info-tab" data-bs-toggle="tab" data-link="info">Info</a>
        </li>
        <li class="nav-item">
            <a href="#source" 
                class="nav-link"
                
                role="tab" id="source-tab" data-bs-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/lib/jobqueue-overview/jobqueue-overview.service.ts</code>
        </p>




        <section data-compodoc="block-index">
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#Error" 
>
                                            Error
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#Finished" 
>
                                            Finished
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#Processing" 
>
                                            Processing
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#Ready" 
>
                                            Ready
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#Waiting" 
>
                                            Waiting
                                        </a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section data-compodoc="block-properties">
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="Error"></a>
                                        <span class="name "><b>Error</b>
                                            <a href="#Error">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>Error:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="Finished"></a>
                                        <span class="name "><b>Finished</b>
                                            <a href="#Finished">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>Finished:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="Processing"></a>
                                        <span class="name "><b>Processing</b>
                                            <a href="#Processing">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>Processing:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="Ready"></a>
                                        <span class="name "><b>Ready</b>
                                            <a href="#Ready">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>Ready:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="Waiting"></a>
                                        <span class="name "><b>Waiting</b>
                                            <a href="#Waiting">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>Waiting:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/number" target="_blank" >number</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { ErrorHandler, Injectable } from &#x27;@angular/core&#x27;;
import { TranslateService } from &#x27;@ngx-translate/core&#x27;;
import { interval, Subscription } from &#x27;rxjs&#x27;;

import { ClassloggerService } from &#x27;../classlogger/classlogger.service&#x27;;
import { AppConfigService } from &#x27;../appConfig/appConfig.service&#x27;;
import { imx_SessionService } from &#x27;../session/imx-session.service&#x27;;
import { EventStreamConfig } from &#x27;imx-api-qbm&#x27;;
import { EntityCollectionChangeData, EntityData } from &#x27;imx-qbm-dbts&#x27;;
import _ from &#x27;lodash&#x27;;

export interface JobQueueGroups {
  Error?: number;
  Waiting?: number;
  Ready?: number;
  Processing?: number;
  Finished?: number;
}

export interface JobQueueDataSlice {
  Time?: Date[];
  Error?: number[];
  Waiting?: number[];
  Ready?: number[];
  Processing?: number[];
  Finished?: number[];
}

@Injectable({
  providedIn: &#x27;root&#x27;,
})
export class JobQueueOverviewService {
  // External values
  public isAvailable &#x3D; false;
  public isAvailablePromise: Promise&lt;void&gt;;
  public queueNames: string[] &#x3D; [];
  public totalStreamName: string;

  // Config Params
  public configParams: EventStreamConfig;

  private stream: EventSource;
  private entities &#x3D; {};
  private table: object[][] &#x3D; [];
  private routineSubscription: Subscription;
  private uidToName &#x3D; {};
  private axisTimes: Date[] &#x3D; [];

  constructor(
    private appConfigService: AppConfigService,
    public session: imx_SessionService,
    public translateService: TranslateService,
    private logger: ClassloggerService,
    private errorHandler: ErrorHandler,
  ) {
    this.translateService.get(&#x27;#LDS#All queues&#x27;).subscribe((trans: string) &#x3D;&gt; (this.totalStreamName &#x3D; trans));
    this.isAvailablePromise &#x3D; new Promise((resolve, reject) &#x3D;&gt; {
      const promiseInterval &#x3D; setInterval(() &#x3D;&gt; {
        if (this.isAvailable) {
          resolve();
          clearInterval(promiseInterval);
        }
      });
    });
  }

  public async setUp(): Promise&lt;void&gt; {
    // Grab config params
    this.configParams &#x3D; await this.session.Client.opsupport_streamconfig_get();

    // Setup connection and event triggers
    this.stream &#x3D; new EventSource(this.appConfigService.BaseUrl + &#x27;/opsupport/queue/overview/stream&#x27;, {
      withCredentials: true,
    });

    this.stream.onopen &#x3D; () &#x3D;&gt; {
      this.logger.debug(this, &#x27;Persistent stream has been created 👍&#x27;);
    };

    this.stream.onmessage &#x3D; (evt) &#x3D;&gt; {
      const changeData: EntityCollectionChangeData &#x3D; JSON.parse(evt.data);
      this.updateValues(changeData);
    };

    this.stream.onerror &#x3D; (err) &#x3D;&gt; {
      this.logger.error(&#x27;JobQueueOverview: An error occured in data stream: &#x27;, err);
      this.isAvailable &#x3D; false;
    };
    const routine &#x3D; interval(this.configParams.RefreshIntervalSeconds * 1000);
    this.routineSubscription &#x3D; routine.subscribe(() &#x3D;&gt; this.jobLoop());
  }

  public updateValues(changeData: EntityCollectionChangeData): void {
    // Maintain current state of entities
    let uid: string;
    let name: string;
    // Decision tree for messages
    if (changeData.New) {
      // Loop over each entity to add to the queues
      changeData.New.forEach((entity) &#x3D;&gt; {
        name &#x3D; entity.Columns[&#x27;QueueName&#x27;].Value;
        uid &#x3D; entity.Columns[&#x27;UID_QBMJobqueueOverview&#x27;].Value;
        this.addEntity(name, entity);
        this.uidToName[uid] &#x3D; name;
      });
      this.checkTotalExists(changeData.New[0]);
    } else if (changeData.Updates) {
      // Loop over all incoming updates, to see if we potentially have more than one queue to update at a time
      for (uid of Object.keys(changeData.Updates)) {
        name &#x3D; this.uidToName[uid];
        this.updateEntites(uid, name, changeData.Updates);
      }
      this.getTotals();
    } else {
      this.errorHandler.handleError(&#x27;JobQueueOverview: Incoming data is not New/Updates 😢&#x27;);
    }
  }

  public checkTotalExists(example: EntityData): void {
    // Check if total queue exists, if not create it off an example entity
    if (!this.queueNames.includes(this.totalStreamName)) {
      this.queueNames.unshift(this.totalStreamName);
      this.addEntity(this.totalStreamName, example, true);
      this.getTotals();
    }
  }

  public addEntity(name: string, entity: EntityData, isTotal: boolean &#x3D; false): void {
    // Add this entity to the list
    this.entities[name] &#x3D; {};
    for (const [key, value] of Object.entries(entity.Columns)) {
      if (key.includes(&#x27;Count&#x27;)) {
        this.entities[name][key] &#x3D; isTotal ? 0 : value.Value;
      }
    }
    // Check if name is already in queue list, prevents total queue from being duped
    if (!this.queueNames.includes(name)) {
      this.queueNames.push(name);
    }
    this.isAvailable &#x3D; true;
  }

  public updateEntites(uid: string, name: string, entity: object): void {
    // Take name of queue and contents of message and update the current entity state
    for (const key of Object.keys(entity[uid])) {
      if (key.includes(&#x27;Count&#x27;)) {
        this.entities[name][key] &#x3D; entity[uid][key].Value;
      }
    }
  }

  public getTotals(): void {
    // Zero out values
    for (const key of Object.keys(this.entities[this.totalStreamName])) {
      this.entities[this.totalStreamName][key] &#x3D; 0;
    }
    // Cumulatively add up all queue entries
    this.queueNames.forEach((queue) &#x3D;&gt; {
      if (queue !&#x3D;&#x3D; this.totalStreamName) {
        for (const [key, value] of Object.entries(this.entities[queue])) {
          this.entities[this.totalStreamName][key] +&#x3D; value;
        }
      }
    });
  }

  public jobLoop(): void {
    // Maintain the internal table of data

    // Check if the session state is logged out, shutdown and exit if so
    if (this.session.SessionState.IsLoggedOut) {
      this.shutdown();
      return;
    }

    // Check status of stream connection
    if (this.stream.readyState &#x3D;&#x3D;&#x3D; 1) {
      this.isAvailable &#x3D; true;
    } else {
      this.isAvailable &#x3D; false;
    }

    // Data check
    this.pushTable();
  }

  public pushTable(): void {
    const currentTable: object[] &#x3D; this.table.pop();
    const incomingTable: object[] &#x3D; [];
    // Replace popped table, if not empty (faster as easier to pop)
    if (currentTable) {
      this.table.push(currentTable);
    }

    // Loop through queues to form new table
    this.queueNames.forEach((queue) &#x3D;&gt; {
      const groups &#x3D; this.computeGroups(queue);
      incomingTable.push(groups);
    });

    // We have no data to use, don&#x27;t append any blank values - usually caused when server hasn&#x27;t started yet
    if (incomingTable.length &#x3D;&#x3D;&#x3D; 0) {
      return;
    }

    if (_.isEqual(incomingTable, currentTable)) {
      // Don&#x27;t add, replace time point with current time
      this.axisTimes.splice(-1, 1, new Date());
    } else {
      // Add new table and time
      this.table.push(incomingTable);
      this.axisTimes.push(new Date());
    }

    // Cull old values off newest push
    this.cullTable();
  }

  public cullTable(): void {
    // Check we have at least two points to cull
    if (this.axisTimes.length &gt; 1) {
      // Check the furthest point in time is sufficiently far to cull
      const now &#x3D; new Date().getTime();
      if (now - this.axisTimes[0].getTime() &gt; this.configParams.HistorySeconds * 1000) {
        this.table.shift();
        this.axisTimes.shift();
      }
    }
  }

  public getSlice(queue: string): JobQueueDataSlice {
    const slice: JobQueueDataSlice &#x3D; {} as JobQueueDataSlice;

    // Safeguard if we haven&#x27;t yet initialized from the component
    if (!queue) {
      return slice;
    }

    slice.Time &#x3D; this.axisTimes;
    const queueIndex &#x3D; this.queueNames.findIndex((e) &#x3D;&gt; e &#x3D;&#x3D;&#x3D; queue);
    // Safeguard that the queue wasnt found
    if (queueIndex &#x3D;&#x3D;&#x3D; -1) {
      return slice;
    }
    this.axisTimes.forEach((e, timeIndex) &#x3D;&gt; {
      for (const [name, value] of Object.entries(this.table[timeIndex][queueIndex])) {
        // Append to array or initialize
        if (slice[name]) {
          slice[name].push(value);
        } else {
          slice[name] &#x3D; [value];
        }
      }
    });
    return slice;
  }

  public computeGroups(queue: string): JobQueueGroups {
    const thisEntity &#x3D; this.entities[queue];
    const output: JobQueueGroups &#x3D; {
      Error: thisEntity.CountFrozen + thisEntity.CountOverlimt + thisEntity.CountMissing,
      Waiting: thisEntity.CountFalse,
      Ready: thisEntity.CountTrue,
      Processing: thisEntity.CountLoaded + thisEntity.CountProcessing,
      Finished: thisEntity.CountFinished + thisEntity.CountHistory + thisEntity.CountDelete,
    };
    return output;
  }

  public shutdown(): void {
    // Destroy connections and clean data
    this.stream.close();
    this.routineSubscription?.unsubscribe();

    this.queueNames &#x3D; [];
    this.isAvailable &#x3D; false;
    this.axisTimes &#x3D; [];
    this.entities &#x3D; {};
    this.table &#x3D; [];
    this.logger.debug(this, &#x27;Stream has successfully shutdown 👍&#x27;);
  }
}
</code></pre>
    </div>
</div>








                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'JobQueueGroups.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
